Raw_data_ <- arrow::read_parquet(
'/Users/andrewleduc/Desktop/jmod_raw/JModPlate1Slide2.parquet'
)
library(stringr)
library(QuantQC)
library(arrow)
getwd()
getwd()/..
getwd()/../
#### Set paths
path_raw <- '/Users/andrewleduc/Desktop/jmod_raw/'
getwd()
read.csv(paste0(getwd(),"/../meta_data/linker_jmod.csv"))
#### Set paths
path_raw <- '/Users/andrewleduc/Desktop/jmod_raw/'
path_meta <- paste0(getwd(),"/../meta_data/linker_jmod.csv")
columns_to_read <-c('file_name','rt','seq','stripped_seq',
'z','plex_Area','protein','channel')
#### Set paths
path_raw <- '/Users/andrewleduc/Desktop/jmod_raw/'
path_meta <- paste0(getwd(),"/../meta_data/linker_jmod.csv")
#### paths for relevant raw and meta data
data_path <- paste0(path_raw,'JModPlate1Slide2.parquet')
linker_path <- paste0(path_meta,"linker_jmod.csv")
one <- paste0(path_meta,"sample_1_try2_isolated.xls")
two <- paste0(path_meta,"sample_2_isolated.xls")
all_cells <- list(mouse1 = one,
mouse2 = two)
#### Initialize QQC object and convert report table to peptide matrix
#### with linked meta data
r1_5day_male <- JMOD_to_QQC(data_path,linker_path, plex = 3, carrier = F)
path_meta <- paste0(getwd(),"/../meta_data/")
data_path <- paste0(path_raw,'JModPlate1Slide2.parquet')
linker_path <- paste0(path_meta,"linker_jmod.csv")
one <- paste0(path_meta,"sample_1_try2_isolated.xls")
two <- paste0(path_meta,"sample_2_isolated.xls")
all_cells <- list(mouse1 = one,
mouse2 = two)
#### Initialize QQC object and convert report table to peptide matrix
#### with linked meta data
r1_5day_male <- JMOD_to_QQC(data_path,linker_path, plex = 3, carrier = F)
r1_5day_male <- Miceotope_cellXpeptide_Jmod(r1_5day_male,chQVal = 1,t = 5)
r1_5day_male <- link_cellenONE_Raw(r1_5day_male,all_cells)
PlotSlideLayout_celltype(r1_5day_male)
PlotSlideLayout_label(r1_5day_male)
View(r1_5day_male@meta.data)
r1_5day_male <- EvaluateNegativeControls(r1_5day_male)
PlotNegCtrl(r1_5day_male)
# log10 intensity as failed cell filter
r1_5day_male <- FilterBadCells(r1_5day_male, min_intens = 9)
# for abundance
nrow(r1_5day_male@matricies@peptide)
r1_5day_male <- Trim_extra_peptides(r1_5day_male)
nrow(r1_5day_male@matricies@peptide)
# for heavy and light peptides
nrow(r1_5day_male@miceotopes@Raw_H)
r1_5day_male <- Trim_extra_peptides_miceotopes(r1_5day_male)
nrow(r1_5day_male@miceotopes@Raw_H)
#### Plot cell size vs MS intensity
PlotCellSizeVsIntensity(r1_5day_male, type = 'sample')
#### Normalize peptide data and collapse to protein level
r1_5day_male@ms_type <- 'miceotopes'
r1_5day_male <- CollapseToProtein(r1_5day_male, 1,LC_correct = T)
r1_5day_male@ms_type
r1_5day_male <- JMOD_to_QQC(data_path,linker_path, plex = 3, carrier = F)
r1_5day_male <- Miceotope_cellXpeptide_Jmod(r1_5day_male,chQVal = 1,t = 5)
r1_5day_male <- link_cellenONE_Raw(r1_5day_male,all_cells)
#### Some QC checks for LC batch effects and nPOP slide viz (optional)
#r1_5day_male <- Calculate_run_order_statistics(r1_5day_male)
# Plot MS Intensity Statistics
#PlotIntensityDrift(r1_5day_male)
#Plot Retention time Statistics
#PlotRTDrift(r1_5day_male)
PlotSlideLayout_celltype(r1_5day_male)
PlotSlideLayout_label(r1_5day_male)
#### Evaluating single cell quality compared to negative controls
#### and filtering out of failed cells
r1_5day_male <- EvaluateNegativeControls(r1_5day_male)
PlotNegCtrl(r1_5day_male)
# log10 intensity as failed cell filter
r1_5day_male <- FilterBadCells(r1_5day_male, min_intens = 9)
#### Remove extra peptides that are lowly abundant for proteins that already have
#### 5 good peptides
# for abundance
nrow(r1_5day_male@matricies@peptide)
r1_5day_male <- Trim_extra_peptides(r1_5day_male)
nrow(r1_5day_male@matricies@peptide)
# for heavy and light peptides
nrow(r1_5day_male@miceotopes@Raw_H)
r1_5day_male <- Trim_extra_peptides_miceotopes(r1_5day_male)
nrow(r1_5day_male@miceotopes@Raw_H)
#### Plot cell size vs MS intensity
PlotCellSizeVsIntensity(r1_5day_male, type = 'sample')
#### Normalize peptide data and collapse to protein level
r1_5day_male@ms_type
r1_5day_male@ms_type <- 'miceotopes'
r1_5day_male <- CollapseToProtein(r1_5day_male, 1,LC_correct = T)
# Viz for LC related batch effects
PlotLC_Deviations(r1_5day_male,global_trend = F)
#### Plot number of proteins peptides and protein level data missingness
r1_5day_male@ms_type <- 'DDA'
PlotProtAndPep(r1_5day_male)
PlotDataComplete(r1_5day_male)
#### Compute and plot correlations between relative peptide levels for peptides
#### mapping to the same protein
r1_5day_male <- SharedPeptideCor(r1_5day_male)
PlotPepCor(r1_5day_male)
median(r1_5day_male@pep.cor[[1]]$Cor)
#### KNN protein level imputation
r1_5day_male <- KNN_impute(r1_5day_male)
cellenONE_meta <- r1_5day_male@meta.data
protein_mat_imputed <- r1_5day_male@matricies@protein.imputed
protein_mat <- r1_5day_male@matricies@protein
# Get meta data for batch correction
batch_label  <- cellenONE_meta %>% dplyr::filter(ID %in% colnames(protein_mat_imputed))
batch_label <- batch_label[order(match(batch_label$ID,colnames(protein_mat_imputed))),]
sc.batch_cor <- limma::removeBatchEffect(r1_5day_male@matricies@protein.imputed,batch = batch_label$label, batch2 = batch_label$sample)
sc.batch_cor_noimp <- sc.batch_cor
sc.batch_cor_noimp[is.na(protein_mat)==T] <- NA
r1_5day_male@matricies@protein.imputed <- sc.batch_cor
r1_5day_male@matricies@protein <- sc.batch_cor_noimp
## Normalize out biases
prot_mat <- r1_5day_male@matricies@protein          # rows = proteins, cols = cells/samples
hb_id    <- "P01942"
hb       <- as.numeric(prot_mat[hb_id, ])
r2 <- rep(NA_real_, nrow(prot_mat))
adj <- prot_mat
for (i in seq_len(nrow(prot_mat))) {
# skip hemoglobin itself
#if (rownames(prot_mat)[i] == hb_id) next
y <- as.numeric(prot_mat[i, ])
ok <- is.finite(y) & is.finite(hb)
if (sum(ok) < 3) next  # not enough points to fit a line
fit <- lm(y[ok] ~ hb[ok])
r2_i <- summary(fit)$r.squared
r2[i] <- r2_i
if (is.finite(r2_i) && r2_i > 0.05) {
# residuals on the full vector (NAs where ok=FALSE)
res <- rep(NA_real_, length(y))
res[ok] <- resid(fit)
# option A: pure residuals (centered around 0)
# adj[i, ] <- res
# option B (usually nicer for “abundance”): add back the original mean
adj[i, ] <- res + mean(y[ok], na.rm = TRUE)
adj[i, ] <- adj[i, ]-mean(adj[i, ],na.rm=T)
}
}
r1_5day_male@matricies@protein <- adj
#### Compute PCA and overlay some cell type markers and potential artifacts
r1_5day_male <- ComputePCA(r1_5day_male, impute = F)
# Hemoglobin
FeaturePCA(r1_5day_male, prot = 'P01942', imputed = F)
# Other source variance?
FeaturePCA(r1_5day_male, prot = 'P12710', imputed = F)
FeaturePCA(r1_5day_male, prot = 'P00329', imputed = F)
# Portal
FeaturePCA(r1_5day_male, prot = 'P33267', imputed = F) #Cyp2f2
FeaturePCA(r1_5day_male, prot = 'Q61176', imputed = F) # Arg1
FeaturePCA(r1_5day_male, prot = 'Q91YI0', imputed = F) # Asl
plot(r1_5day_male@matricies@protein['Q05421',],r1_5day_male@matricies@protein['P33267',])
cor(r1_5day_male@matricies@protein['Q05421',],r1_5day_male@matricies@protein['P33267',],use = 'pairwise.complete.obs')
FeaturePCA(r1_5day_male, prot = 'Q05421', imputed = F) # Cyp2e1
FeaturePCA(r1_5day_male, prot = 'P15105', imputed = F) # Glul
# plot PCA options are "Run order" "Total protein" "Condition" "Label"
PlotPCA(r1_5day_male, by = "Condition")
PlotPCA(r1_5day_male, by = "Run order")
PlotPCA(r1_5day_male, by = "Total protein")
PlotPCA(r1_5day_male, by = "Label")
getwd()
write.csv(r1_5day_male@matricies@protein,paste0(getwd(),'../data_out_temp/R_pipeline_protein.csv'))
paste0(getwd(),'../data_out_temp/R_pipeline_protein.csv')
getwd()
r1_5day_male@matricies@protein
r1_5day_male@miceotopes@Alpha_pep
getwd()
write.csv(r1_5day_male@matricies@protein,paste0(getwd(),'/../data_out_temp/R_pipeline_protein.csv'))
write.csv(r1_5day_male@miceotopes@Alpha_pep,paste0(getwd(),'/../data_out_temp/R_pipeline_alpha_pep.csv'))
